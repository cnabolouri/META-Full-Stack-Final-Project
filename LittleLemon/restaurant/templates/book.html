{% extends 'base.html' %}
{% block content %}
<section>
  <article>
    <h1>Book a table</h1>

    <form method="post" id="booking-form">
      {% csrf_token %}
      {{ form.as_p }}
      <button id="button" type="submit">Book</button>
    </form>
  </article>

  <article>
    <h2>Reserved time slots</h2>
    <p id="no-reservations" style="display:none;">No bookings for this date.</p>
    <ul id="reserved-list" class="reserved-list" style="list-style:none;padding-left:0;margin:0;display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;">
      <!-- items injected by JS -->
    </ul>
  </article>
</section>

<script>
  // Helpers
  function todayISO() {
    const d = new Date();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${mm}-${dd}`;
  }

  function fmtTime(hhmm) {
    // "14:30" -> "2:30 PM"
    const [h,m] = hhmm.split(':').map(Number);
    const d = new Date();
    d.setHours(h, m, 0, 0);
    return d.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
  }

  async function loadReserved(dateISO) {
    const url = `/bookings?date=${encodeURIComponent(dateISO)}`;
    const res = await fetch(url);
    if (!res.ok) return;

    const data = await res.json();
    const list = document.getElementById('reserved-list');
    const emptyMsg = document.getElementById('no-reservations');
    list.innerHTML = '';

    if (!data.reserved || data.reserved.length === 0) {
      emptyMsg.style.display = 'block';
      return;
    }
    emptyMsg.style.display = 'none';

    data.reserved.forEach(t => {
      const li = document.createElement('li');
      li.textContent = fmtTime(t);
      li.style.padding = '8px 10px';
      li.style.borderRadius = '12px';
      li.style.boxShadow = '0 1px 6px rgba(0,0,0,.08)';
      li.style.background = '#fff';
      li.style.textAlign = 'center';
      li.setAttribute('data-time', t);
      list.appendChild(li);
    });

    // Optional: disable already-booked times in the reservation_time <select> if you’re using a select
    const timeSelect = document.getElementById('id_reservation_time');
    if (timeSelect) {
      const reservedSet = new Set(data.reserved);
      [...timeSelect.options].forEach(opt => {
        const val = opt.value; // "HH:MM:SS" or "HH:MM"
        const short = val.length === 8 ? val.slice(0,5) : val;
        opt.disabled = reservedSet.has(short);
      });
    }
  }

  // Auto-load for the date in the form (today by default if empty)
  document.addEventListener('DOMContentLoaded', () => {
    const dateInput = document.getElementById('id_reservation_date');
    if (dateInput && !dateInput.value) {
      // set today if your form doesn’t already do this
      dateInput.value = todayISO();
    }
    if (dateInput) {
      loadReserved(dateInput.value);
      dateInput.addEventListener('change', () => loadReserved(dateInput.value));
    }
  });
</script>
{% endblock %}
